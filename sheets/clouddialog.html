<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
  <link rel="stylesheet" href="https://handtop.com/global/common.css">
  <link rel="stylesheet" href="https://handtop.com/asset/app.css">
  <script src="https://handtop.com/global/globalutil.js"></script>
  <script src="https://handtop.com/global/ginstancesuper.js"></script>
  <script src="https://handtop.com/controller/cmacro.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.min.js"></script>
  <script src="https://rawgit.com/corbanbrook/dsp.js/a7b2e97b1385a43083e50ed6dc81d697f0e57e28/dsp.js"></script>
</head>

<body>
  <div class="body_flex_wrapper">
    <div class="target_header" style="flex:0">
      <span id="selected_target_span">Loading</span>
      <span id="selected_project_span">Loading</span>
      <div style="clear:both;"></div>
    </div>
    <div style="display:flex;flex-direction:row;flex:0">
      <select id="addon_display_view_select">
        <option value="cloud_target">Configuration</option>
        <option value="cloud_deploy" selected>Catalog Projects</option>
        <option value="template_view">Sheet Templates</option>
        <option value="block_wizards">Block Wizards</option>
        <option value="song_import_div">Process Audio</option>
      </select>
      <div style="padding:0 4px;">
        <button id="show_help_panel_btn"><i class="material-icons">help</i></button>
      </div>
      <div style="padding-right:8px">
        <button id="reload_addon"><i class="material-icons">refresh</i></button>
      </div>
    </div>
    <div id="help_viewer_panel" style="display:none;flex:.3;">
      <b>Configuration</b><br>
      &nbsp; Select a server and token for project deployment and image uploading<br>
      &nbsp; View key fields from [Configuration] sheet
      <br><br>
      <b>Catalog Projects</b><br>
      &nbsp; Select a project for image uploading or to deploy<br>
      &nbsp; Deploy all projects<br>
      <br>
      <b>Sheet Templates</b><br>
      &nbsp; Create sheets for catalogs and configuration
      <br><br>
      <b>Block Wizards</b><br>
      &nbsp; Helpers to create lines, meshes and scenes<br>
      <br>
      <b>Audio Animation</b><br>
      &nbsp; Tools to FFT audio files to generate animation frames<br>
      <br>
    </div>
    <div id="cloud_target" class="main_div_wrapper">
      <select id="deploy_options_server_list" class="select_list" size="5">
        <option selected>Loading</option>
      </select>
      <div class="select_flex_view" style="flex:1;">
        <div style="display:flex;flex-direction:row;padding:2px 8px">
          <div style="padding: 2px">Target</div>
          <input id="target_to_deploy" style="flex:1" type="text" />
        </div>
        <div style="display:flex;flex-direction:row;padding: 2px 8px">
          <div style="padding: 2px">Token</div>
          <input id="token_to_deploy" type="text" style="flex:1" />
        </div>
        <div id="url_to_deploy" style="padding:.5em;"></div>
        <div style="padding:4px">
          <button id="target_server_set_button" class="green">Set Server</button>
        </div>
        <div id="selected_server_details_div"></div>
        <div id="assets_anchor"> loading...</div>
      </div>
    </div>
    <div id="cloud_deploy" class="main_div_wrapper" style="display:flex">
      <select id="project_deploy_select" class="select_list" size="5"></select>
      <div style="display:flex;flex-direction:row;">
        <label style="flex:1"><input type="radio" name="project_view_radio" id="rdo_project_deploy_view" checked>Details</label>
        <label style="flex:1"><input type="radio" name="project_view_radio" id="rdo_project_display_view">Display</label>
        <label style="flex:1"><input type="radio" name="project_view_radio" id="rdo_project_upload_view">Upload</label>
        <a id="selected_display_anchor" style="padding: 1px 8px;"></a>
        <a id="selected_edit_anchor" style="padding:1px;padding-right:16px;"></a>
      </div>
      <div class="select_flex_view" style="padding-top:4px">
        <div id="project_display_view" style="display:none;height:inherit;flex:1">
          <iframe id="preview_panel"></iframe>
        </div>
        <div id="project_deploy_view" style="display:none;flex-direction: column;flex:1;padding:8px;padding-top:0;width: 100%;">
          <div style="padding: 0 8px">
            <button id="set_default_proj" class="blue"><i class="material-icons">push_pin</i> Pin</button>
            &nbsp;
            <button id="display_publish_single" class="blue">Deploy</button>
            &nbsp;
            <button id="display_publish_list" class="blue">Deploy All</button>
          </div>
          <textarea id="publish_results" style="flex:1;margin-top:8px"></textarea>
        </div>
        <div id="project_upload_view" style="display:none;flex-direction: column;height:inherit;width: 100%">
          <div>
            <label>Name <input id="file_upload_name"></label>
            <button id="upload_file_cloud" class="blue">Upload File</button>
            <input type="file" id="upload_file_input" style="display:none;">
          </div>
          <div style="flex:1;overflow:hidden;">
            <img id="img_preview" style="max-width:100%;max-height:100%">
          </div>
          <a id="img_preview_link" style="line-break:anywhere;" target="_blank"></a>
        </div>
      </div>
    </div>
    <div id="template_view" class="main_div_wrapper">
      <select id="circuit_template_select" class="select_list" size="5">
      </select>
      <div class="select_flex_view">

        <div style="display:flex;flex-direction:row;padding: 8px;">
          <div style="padding: 0 4px;">Name </div>
          <input id="sheetname" style="flex:1;">
        </div>
        <div style="display:flex;flex-direction:row;padding: 0 8px;">
          <label style="flex:1;padding-top:4px;"> <input type="checkbox" id="add_to_publishlist" checked>Add to Projects </label>
          <button id="create_layout_btn" class="green" style="flex:1">Create</button>
        </div>
        <div id="template_description" style="padding: 8px"></div>
      </div>
    </div>

    <div id="block_wizards" class="main_div_wrapper">
        <div id="block_wizard_select_wrapper" style="display:flex;flex-direction:row;padding:8px;">
          <select id="wizard_choices" style="margin-right: 8px;">
            <option value="block">Block</option>
            <option value="mesh">Mesh</option>
            <option value="material">Material</option>
          </select>
        </div>
        <div id="macro_details_wrapper" class="add-asset-template-panel">
        </div>
    </div>
    <div id="song_import_div" class="main_div_wrapper">
      <label>seconds to sample (empty for length)<input id="seconds_to_sample" type="text" /></label>
      <br>
      <label>freq samples per second<input id="freq_samples_to_second" type="text" value="10" /></label>
      <br>
      <label>result bands
        <select id="bands_to_combine">
          <option value="1">256</option>
          <option value="2">128</option>
          <option value="4">64</option>
          <option value="8">32</option>
          <option value="16" selected>16</option>
          <option value="32">8</option>
        </select>
      </label>
      <br>
      <br><label>
        WAV Audio File:
        <input type="file" id="audio_file" style="width:100%" /></label>

      <br>
      <br>
      <audio id="audio" controls style="width:250px;"></audio>
      <div id="song_len_sec">&nbsp;</div>
      <textarea id="raw_data" style="width:260px;height:200px;"></textarea>
    </div>
  </div>

  <script>
    class PublishWeb {
      constructor() {
        this.initDom();
        this.initSheetBasedData();

        this.loadTemplateList();
        this.app = new cAppDefaults();
        this.app.jsonLibPrefix = 'https://handtop.com';
        this.app.loadTextures();
        this.app.loadPickerData();
        this.widForName = {};
        this.loadBlockWizard();
      }
      async setBusy() {
        this.reload_addon.style.borderRadius = '50%';
        this.reload_addon.style.background = 'rgb(150,220,150)';
      }
      async clearBusy() {
        this.reload_addon.style.borderRadius = '';
        this.reload_addon.style.background = '';
      }
      async initSheetBasedData() {
        this.setBusy();
        await this.loadConfiguration();
        await Promise.all([
          this.loadDeployOptions(),
          this.loadProjectSelectList()
        ]);
        this.clearBusy();
      }
      initDom() {
        let dom_id = [
          'publish_results', 'target_to_deploy', 'token_to_deploy', 'url_to_deploy', 'project_deploy_select',
          'deploy_options_server_list', 'display_publish_list', 'assets_anchor', 'selected_display_anchor',
          'selected_edit_anchor', 'upload_file_cloud', 'file_upload_name', 'upload_file_input', 'img_preview',
          'img_preview_link', 'display_publish_single', 'set_default_proj', 'preview_panel',
          'sheetname', 'circuit_template_select', 'help_viewer_panel', 'block_wizard_select_wrapper',
          'create_layout_btn', 'add_to_publishlist', 'template_description', 'macro_details_wrapper', 'wizard_choices',
          'seconds_to_sample', 'bands_to_combine', 'freq_samples_to_second',
          'addon_display_view_select', 'audio', 'audio_file', 'reload_addon', 'selected_target_span', 'selected_project_span',
          'target_server_set_button', 'selected_server_details_div', 'project_display_view', 'project_deploy_view', 'project_upload_view',
          'rdo_project_display_view', 'rdo_project_deploy_view', 'rdo_project_upload_view', 'show_help_panel_btn'
        ];

        dom_id.forEach(ctl => {
          this[ctl] = document.getElementById(ctl);
          if (!this[ctl])
            console.log('element for DOM ID ' + ctl + ' not found')
        });

        this.display_publish_list.addEventListener('click', e => this.cloudDeployProjects('all'));
        this.project_deploy_select.addEventListener('input', e => this.loadProjectView());
        this.rdo_project_display_view.addEventListener('input', e => this.loadProjectView());
        this.rdo_project_deploy_view.addEventListener('input', e => this.loadProjectView());
        this.rdo_project_upload_view.addEventListener('input', e => this.loadProjectView());
        this.deploy_options_server_list.addEventListener('input', e => this.loadServerDetails());
        this.file_upload_name.addEventListener('input', e => this.loadImagePreview());
        this.upload_file_cloud.addEventListener('click', e => this.upload_file_input.click());
        this.upload_file_input.addEventListener('change', e => this.storageUploadProjectFile(e));
        this.display_publish_single.addEventListener('click', e => this.cloudDeployProjects('selected'));
        this.set_default_proj.addEventListener('click', e => this.sheetsStoreSelectedProject());
        this.addon_display_view_select.addEventListener('input', e => this.loadAddonView());
        this.circuit_template_select.addEventListener('input', e => this.loadTemplateDetails());
        this.create_layout_btn.addEventListener('click', e => this.templateCreateSheets());
        this.reload_addon.addEventListener('click', e => this.initSheetBasedData());
        this.target_server_set_button.addEventListener('click', e => this.cloudDeploySetServer());

        this.wizard_choices.addEventListener('change', e => this.loadBlockWizard());
        this.audio_file.addEventListener('change', e => this.audioProcessFileSelected());

        this.show_help_panel_btn.addEventListener('click', e => this.helpPanelToggle());
      }

      async loadConfiguration() {
        this.configurationCSV = await this.sheetsJSONforSheetCSV('Configuration');
        if (!this.configurationCSV || this.configurationCSV.length === 0)
          this.configurationCSV = [{}];
        this.assetBookId = this.configurationCSV[0]['Assets Doc ID'];

        this.defaultServerTarget = '';
        if (this.configurationCSV[0]['Target Server']) {
          this.defaultServerTarget = this.configurationCSV[0]['Target Server'];
          this.selected_target_span.innerHTML = this.defaultServerTarget;
        } else {
          this.selected_target_span.innerHTML = 'No Server Target';
        }

        this.defaultProjectTarget = '';
        if (this.configurationCSV[0]['Target Project']) {
          this.defaultProjectTarget = this.configurationCSV[0]['Target Project'];
          this.selected_project_span.innerHTML = this.defaultProjectTarget;
        } else {
          this.selected_project_span.innerHTML = 'No Project Target';
        }

        this.defaultToken = '';
        if (this.configurationCSV[0]['Target Token'])
          this.defaultToken = this.configurationCSV[0]['Target Token'];

        this.projectsSheetName = 'Projects';
        if (this.configurationCSV[0]['Catalog List'])
          this.projectsSheetName = this.configurationCSV[0]['Catalog List'];
      }
      async loadDeployOptions() {
        let deployOptionsRange = "'Deploy Options'!A1:A2";

        let rangeString = this.assetBookId + "||||" + deployOptionsRange;
        if (!this.assetBookId)
          rangeString = deployOptionsRange;

        let deploys = await this.sheetsJSONforRangeListCSV([rangeString]);
        let targetRange = deploys[0].deployrange;
        let assetRString = this.assetBookId + "||||'Deploy Options'!" + targetRange;
        if (!this.assetBookId)
          assetRString = "'Deploy Options'!" + targetRange;
        let targets = await this.sheetsJSONforRangeListCSV([assetRString]);
        this.deployTargets = targets;
        let configDetailsHTML = '';
        if (this.assetBookId) {
          let url = "https://docs.google.com/spreadsheets/d/";
          url += this.assetBookId.toString();
          let open = '<a target="_blank" href="' + url + '">Open</a>';
          configDetailsHTML += '<hr>Main Spreadsheet Id &nbsp;' + open + '<br> <span style="font-size:.85em">' + this.assetBookId.toString() + '</span>';
        } else {
          configDetailsHTML += 'Main Spreadsheet Id<br> <span style="font-size:.85em">None</span>';
        }

        let dtext = '';
        if (this.configurationCSV[0]['Catalog List'] === '')
          dtext = ' (default)';
        configDetailsHTML += '<hr>Projects Sheet Name<br>' + this.projectsSheetName + dtext;
        this.assets_anchor.innerHTML = configDetailsHTML;

        let sIndex = this.deploy_options_server_list.selectedIndex;
        let listHTML = '';
        targets.forEach(t => {
          let pid = t['project id'];
          if (!pid)
            pid = '';
          listHTML += '<option>' + pid + '</option>';
        });
        this.deploy_options_server_list.innerHTML = listHTML;
        this.deploy_options_server_list.selectedIndex = (sIndex === -1) ? 0 : sIndex;
        this.loadServerDetails();
      }
      async loadServerDetails() {
        let index = deploy_options_server_list.selectedIndex;
        if (index < 0)
          return;
        let t = this.deployTargets[index];
        let id = t['project id'];
        if (!id)
          id = '';
        let token = t['token'];
        if (!token)
          token = '';
        this.target_to_deploy.value = id;
        this.token_to_deploy.value = token;
        let url = t['public url'];
        if (!url)
          url = 'https://' + id + '.web.app/';
        let navurl = url;
        if (url.substring(0, 3) !== 'htt')
          url = 'https://' + url;
        this.url_to_deploy.innerHTML = '<a target="_blank" href="' + navurl + '">' + url + '</a>';
      }
      async loadTemplateDetails() {
        let data = this.templateMap[this.circuit_template_select.value];
        if (data.hint) {
          this.sheetname.value = data.hint;
        }

        if (data.description) {
          this.template_description.innerHTML = data.description;
        } else {
          this.template_description.innerHTML = '';
        }

        if (data.addToProjectList)
          this.add_to_publishlist.checked = true;
        else {
          this.add_to_publishlist.checked = false;
        }
        return;
      }
      async loadBlockWizard() {
        if (this.block_wizard_add_name_div)
          this.block_wizard_add_name_div.remove();
        this.macro = new cMacro(this.macro_details_wrapper, this.wizard_choices.value, this.app, true);

        this.block_wizard_add_name_div = document.querySelector('.block_wizard_add_name_div');
        this.block_wizard_select_wrapper.appendChild(this.block_wizard_add_name_div);

        let handleImageTextureUpload = async (fileCtl, field) => {
          let fileBlob = fileCtl.files[0];

          if (!fileBlob)
            return;
          field.value = 'Uploading...';
          let filename = fileBlob.name;

          if (!this.defaultProjectTarget) {
            alert('No default project configured');
            return;
          }
          if (!this.defaultServerTarget) {
            alert('No default target server configured');
          }
          if (!this.defaultToken) {
            alert('No default token configured');
          }

          let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/fileupload?name=' + encodeURIComponent(this.defaultProjectTarget);
          url += '&token=' + encodeURIComponent(this.defaultToken);
          url += '&filename=' + encodeURIComponent(filename);

          let body = new FormData();
          body.append('file', fileBlob);

          let genResponse = await fetch(url, {
            method: "post",
            body
          });
          let genResults = await genResponse.json();
          if (genResults.success)
            if (genResults.result_msg.success) {
              field.value = genResults.result_msg.signed_url;
              let event = new Event('input', {
                bubbles: true,
                cancelable: true,
              });

              field.dispatchEvent(event);
              return genResults;
            }

          field.value = '';
          alert('upload did not complete');
          return null;
        };

        this.macro._handleImageTextureUpload = (fileCtl, field) => {
          return handleImageTextureUpload(fileCtl, field);
        };

        await this.app.updateHelpView(this.wizard_choices.value, this.help_viewer_panel);

        return null;
      }
      async loadAddonView() {
        let wrappers = document.body.querySelectorAll('.main_div_wrapper');
        wrappers.forEach(w => w.style.display = 'none');

        if (this.addon_display_view_select.value !== 'cloud_deploy')
          this.preview_panel.setAttribute('src', '');
        else
          this.loadProjectView();

        let ele = document.getElementById(this.addon_display_view_select.value);
        if (ele)
          ele.style.display = 'flex';

        return;
      }
      async loadProjectPreview() {
        if (this.rdo_project_display_view.checked) {
          let src = this.selected_display_anchor.getAttribute('href');
          this.preview_panel.setAttribute('src', src);
        } else {
          this.preview_panel.setAttribute('src', '');
        }
        return null;
      }
      async loadTemplateList() {
        let genResponse = await fetch('https://www.handtop.com/addontemplates/templatelist.json', {
          method: "get"
        });
        this.templateListResults = await genResponse.json();

        let html = '';
        let selected = 'selected';
        let templateMap = {};
        this.templateListResults.forEach(i => {
          html += '<option value="' + i.key + '" ${selected}>' + i.name + '</option>';
          selected = '';
          templateMap[i.key] = i;
        });
        this.templateMap = templateMap;
        this.circuit_template_select.innerHTML = html;
      }
      async loadImagePreview(new_url) {
        if (this.updatingImagePreview) {
          clearTimeout(this.refreshPreview);
          this.refreshPreview = setTimeout(() => this.loadImagePreview(), 50);
          return;
        }
        this.updatingImagePreview = true;
        this.signed_url = new_url;

        let name = this.file_upload_name.value;
        if (!name || !this.defaultServerTarget || !this.defaultToken) {
          this.img_preview.setAttribute('src', '');
          this.img_preview_link.setAttribute('href', '');
          this.img_preview_link.innerHTML = '';
          this.updatingImagePreview = false;
          return;
        }


        let tag = 'cloudupload';
        let wid = 'none';
        let selectedProject = this.project_deploy_select.value;
        if (this.defaultServerTarget)
          wid = this.widForName[selectedProject];

        if (!wid) {
          let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/widforname/?name=' + encodeURIComponent(selectedProject);
          url += '&token=' + encodeURIComponent(this.defaultToken);
          let genResponse = await fetch(url, {
            method: "get"
          });
          let genResults = await genResponse.text();
          let r = JSON.parse(genResults);
          wid = r.wid;
          console.log('wid', r);
          window.bucketName = r.bucket;
          this.widForName[this.defaultServerTarget] = wid;
        }
        this.referencePath = 'project/' + wid + '/' + tag + '/';

        if (!this.signed_url)
          this.signed_url = "https://firebasestorage.googleapis.com/v0/b/" +
          window.bucketName + "/o/" + encodeURIComponent(this.referencePath + name) + "?alt=media&token=" + 'token';

        let signed_url = this.signed_url;
        if (signed_url)
          signed_url += '&randomstuff=' + Number(new Date()).toString();
        this.img_preview.setAttribute('src', signed_url);
        this.img_preview_link.setAttribute('href', signed_url);
        this.img_preview_link.innerHTML = 'Open in new Window';
        this.updatingImagePreview = false;
      }
      async loadProjectView() {
        this.loadProjectPreview();
        this.project_deploy_view.style.display = this.rdo_project_deploy_view.checked ? 'flex' : 'none';
        this.project_upload_view.style.display = this.rdo_project_upload_view.checked ? 'flex' : 'none';
        this.project_display_view.style.display = this.rdo_project_display_view.checked ? '' : 'none';

        let selectedProject = this.project_deploy_select.value;
        let pid = this.defaultServerTarget;
        let link = 'https://' + pid + '.web.app/display/?name=' + selectedProject;
        this.selected_display_anchor.setAttribute('href', link);
        this.selected_display_anchor.innerHTML = 'View';
        this.selected_display_anchor.setAttribute('target', "_blank");

        let editLink = 'https://' + pid + '.web.app/asset/?name=' + selectedProject;
        this.selected_edit_anchor.setAttribute('href', editLink);
        this.selected_edit_anchor.innerHTML = 'Edit';
        this.selected_edit_anchor.setAttribute('target', "_blank");


        this.loadImagePreview();
      }
      async loadProjectSelectList() {
        let sel = this.project_deploy_select.selectedIndex;
        let publishList = await this.sheetsJSONforSheetCSV(this.projectsSheetName);
        this.publistList = publishList;
        let linkListHTML = '';
        let pid = this.defaultServerTarget;
        publishList.forEach(t => {
          linkListHTML += '<option>' + t['name'] + '</option>';
        });
        this.project_deploy_select.innerHTML = linkListHTML;
        this.project_deploy_select.selectedIndex = sel > -1 ? sel : 0;
        this.loadProjectView();
      }

      async sheetsCreateTemplateSheet(layoutName, sheetName, baseSheetName = '') {
        let sheets = layoutName.split(',');

        this.create_layout_btn.innerHTML = '...';
        let genResponse = await fetch('https://www.handtop.com/addontemplates/template_' + layoutName + '.json', {
          method: "get"
        });
        let genText = await genResponse.text();
        if (baseSheetName)
          genText = genText.split('##sheetname').join("'" + baseSheetName + "'");

        let genResults = JSON.parse(genText);
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler(async (result) => {
            this.create_layout_btn.innerHTML = 'Create Sheet';
            if (result !== 'success') {
              alert(result);
            } else {
              if (this.add_to_publishlist.checked && baseSheetName)
                await this.sheetsAddToProjectList(baseSheetName);
            }

            resolve(result);
          }).createSheetFromTemplate(sheetName, genResults);
        });
      }
      async sheetsAddToProjectList(baseSheetName) {
        return new Promise((resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            resolve(result);
          }).AddRowToSheet('PublishList', [baseSheetName, '', "='" + baseSheetName + "'!C2"]);
        });
      }
      async sheetsStoreSelectedProject() {
        this.setBusy();
        let project = this.project_deploy_select.value;
        await this.sheetsStoreCSVValue('Configuration', 1, 'Target Project', project);
        this.initSheetBasedData();
      }
      async sheetsStoreCSVValue(sheetName, rowIndex, field, value) {
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            resolve(result);
          }).SetCSVSheetValue(sheetName, rowIndex, field, value);
        });
      }
      async sheetsJSONforSheetCSV(sheetName) {
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            console.log('json for sheet', sheetName, result.length);
            resolve(result);
          }).getJSONFromCSVSheet(sheetName);
        });
      }
      async sheetsJSONforRangeListCSV(rangeStrings) {
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            console.log(rangeStrings, result.length);
            resolve(result);
          }).mergeCSVRangeStrings(rangeStrings, true);
        });
      }

      async cloudDeploySetServer() {
        this.setBusy();
        let token = this.token_to_deploy.value;
        let server = this.target_to_deploy.value;

        await this.sheetsStoreCSVValue('Configuration', 1, 'Target Token', token);
        await this.sheetsStoreCSVValue('Configuration', 1, 'Target Server', server);

        this.initSheetBasedData();
      }
      async templateCreateSheets() {
        let sheetName = this.sheetname.value;
        let templateString = this.circuit_template_select.value;
        let templates = templateString.split(',');

        if (!sheetName) {
          alert('Sheet name required');
          return null;
        }

        let promises = [];
        templates.forEach((item, i) => {
          let parts = item.split(':');
          let suffix = parts[1];
          if (!suffix)
            suffix = '';
          let name = sheetName + suffix;
          promises.push(this.sheetsCreateTemplateSheet(parts[0], name, sheetName));
        });

        return Promise.all(promises);
      }
      async cloudDeployProjects(set) {
        if (this.busy)
          return;

        let singleIndex = null;
        if (set === 'selected') {
          singleIndex = this.project_deploy_select.selectedIndex;
        }
        this.display_publish_list.innerHTML = 'Working...';
        this.display_publish_single.innerHTML = 'Working...';
        this.publish_results.value = '';
        this.dataCache = {};

        this.busy = true;

        let publishList = await this.sheetsJSONforSheetCSV(this.projectsSheetName);

        let deleteProject = async (name) => {
          let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/delete/?name=' + encodeURIComponent(name);
          url += '&token=' + encodeURIComponent(this.defaultToken);
          let genResponse = await fetch(url, {
            method: "post"
          });
          let genResults = await genResponse.text();
          let r = {
            result_msg: 'unknown'
          };
          try {
            r = JSON.parse(genResults);
          } catch (e) {
            console.log(e, genResults);
          }

          return r;
        };
        let publishSingle = async (name, assetRanges, circuitRanges, catalogSheet) => {
          console.log(name, assetRanges, circuitRanges, catalogSheet);
          let step = 'Assets';
          try {
            let assetResults = {};
            if (assetRanges) {

              let assets = null;
              if (this.dataCache[assetRanges])
                assets = this.dataCache[assetRanges];

              if (!assets) {
                let ranges = assetRanges.split(',');
                assets = await this.sheetsJSONforRangeListCSV(ranges);
                console.log('asset fetch');
              }
              console.log('assets', assets);
              let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/upload?name=';
              url += encodeURIComponent(name) + '&type=asset';
              url += '&token=' + encodeURIComponent(this.defaultToken);
              let json = JSON.stringify(assets);

              let response = await fetch(url, {
                method: "post",
                body: json
              });
              let r = await response.text();
              assetResults = JSON.parse(r);

              if (assetResults.success) {
                this.dataCache[assetRanges] = assets;
                this.publish_results.value += name + ':assets: ' + assets.length.toString() + '\n';
              } else {
                this.publish_results.value += name + ':assets: Error ';
                this.publish_results.value += assetResults.errorMessage + '\n';
              }
              this.publish_results.scrollTop = this.publish_results.scrollHeight;
            }
            step = "Circuit";
            let sceneResults = {};
            if (circuitRanges) {

              let scene = null;
              if (this.dataCache[circuitRanges])
                scene = this.dataCache[circuitRanges];

              if (!scene) {
                let ranges = circuitRanges.split(',');
                scene = await this.sheetsJSONforRangeListCSV(ranges);
                console.log('scene fetched');
              }
              console.log('c', scene);
              let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/upload?name=';
              url += encodeURIComponent(name) + '&type=scene';
              url += '&token=' + encodeURIComponent(this.defaultToken);
              let json = JSON.stringify(scene);
              let response = await fetch(url, {
                method: "post",
                body: json
              });
              let r = await response.text();
              sceneResults = JSON.parse(r);

              if (sceneResults.success) {
                this.dataCache[circuitRanges] = scene;
                this.publish_results.value += name + ':circuit: ' + scene.length.toString() + '\n';
              } else {
                this.publish_results.value += name + ':circuit: Error ';
                this.publish_results.value += sceneResults.errorMessage + '\n';
              }
              this.publish_results.scrollTop = this.publish_results.scrollHeight;
            }

            step = "Products";
            let productResults = {};
            if (catalogSheet) {
              let products = await this.sheetsJSONforSheetCSV(catalogSheet);
              let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/upload?name=';
              url += encodeURIComponent(name) + '&type=product';
              url += '&token=' + encodeURIComponent(this.defaultToken);
              let json = JSON.stringify(products);
              let response = await fetch(url, {
                method: "post",
                body: json
              });
              let r = await response.text();
              productResults = JSON.parse(r);

              if (productResults.success) {
                this.publish_results.value += name + ':products: ' + products.length.toString() + '\n'
              } else {
                this.publish_results.value += name + ':products: Error ';
                this.publish_results.value += productResults.errorMessage + '\n';
              }
              this.publish_results.scrollTop = this.publish_results.scrollHeight;
            }

            step = "Generate";
            let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/generate/?name=' + encodeURIComponent(name);
            url += '&token=' + encodeURIComponent(this.defaultToken);
            let genResponse = await fetch(url, {
              method: "post"
            });
            let gr = await genResponse.text();
            let genResults = JSON.parse(gr);

            if (genResults.success) {
              this.publish_results.value += name + ' generated\n\n'
            } else {
              this.publish_results.value += name + ':generate: Error ';
              this.publish_results.value += genResults.errorMessage + '\n';
            }
            this.publish_results.scrollTop = this.publish_results.scrollHeight;

            return {
              genResults,
              productResults,
              assetResults,
              sceneResults
            };
          } catch (error) {
            console.log('e', error);
            this.publish_results.value += '\nERROR ' + step + '\n';
            this.publish_results.value += error.message;
            this.publish_results.scrollTop = this.publish_results.scrollHeight;
            return {
              error: error
            };
          }
        };

        let promises = [];
        let start = 0;
        let end = publishList.length - 1;

        if (singleIndex !== null) {
          start = singleIndex;
          end = singleIndex;
        }

        this.publish_results.value = publishList.length.toString() + ' Items in ' + this.projectsSheetName + '\n\n';

        for (let c = start; c <= end; c++) {
          let row = publishList[c];
          let flags = row.flags;
          if (!flags) flags = '';
          flags = flags.toLowerCase();

          if (flags.indexOf('ignore') !== -1) {
            this.publish_results.value += row.name + ' ignored\n';
            continue;
          }

          if (flags.indexOf('remove') !== -1) {
            let r_result = await deleteProject(row.name);
            if (r_result.success)
              this.publish_results.value += row.name + ' removed\n\n';
            else {
              this.publish_results.value += row.name + ' NOT removed\n';
              this.publish_results.value += 'ERROR: ' + r_result.errorMessage + '\n\n';
            }

            console.log(c, 'remove', r_result);
            continue;
          }


          this.publish_results.scrollTop = this.publish_results.scrollHeight;
          let result = await this.publishSingle(row.name, row.assetranges, row.circuitranges, row.catalogsheet);
          console.log(c, result);
        }
        this.busy = false;
        this.display_publish_list.innerHTML = 'Process All Again';
        this.display_publish_single.innerHTML = 'Process Single Again';

        this.publish_results.value += '\nComplete\n\n';
        this.publish_results.scrollTop = this.publish_results.scrollHeight;
      }
      async storageUploadProjectFile(e) {
        let filename = this.file_upload_name.value.trim();
        let selectedProject = this.project_deploy_select.value;

        if (this.file_upload_name.value === '') {
          this.file_upload_name.value = this.upload_file_input.files[0].name;
          filename = this.file_upload_name.value;
        }
        let url = 'https://us-central1-' + this.defaultServerTarget + '.cloudfunctions.net/fileupload?name=' + encodeURIComponent(selectedProject);
        url += '&token=' + encodeURIComponent(this.defaultToken);
        url += '&filename=' + encodeURIComponent(filename);

        let body = new FormData();
        body.append('file', this.upload_file_input.files[0]);

        let genResponse = await fetch(url, {
          method: "post",
          body
        });
        let genResults = await genResponse.text();
        let r = {
          result_msg: 'unknown'
        };
        try {
          r = JSON.parse(genResults);
        } catch (e) {
          console.log(e, genResults);
        }
        console.log(r);
        if (r.success)
          if (r.result_msg.success) {
            this.loadImagePreview(r.result_msg.signed_url);
            this.upload_file_input.value = '';
            return r;
          }
        this.loadImagePreview('');

        this.upload_file_input.value = '';
        alert('upload did not complete');
        return r;
      }
      async audioProcessFileSelected() {
        document.getElementById('raw_data').value = '';
        document.getElementById('song_len_sec').innerHTML = '&nbsp;';

        let resampleData = (arrayIn, secondsLength, samplesPerSecondOut) => {
          let outArray = [];
          arrayIn.forEach(bandArray => {
            let outBand = [];
            let sampleCountFactor = bandArray.length / (secondsLength * samplesPerSecondOut);
            let runningFactor = 0;

            let sampleSum = 0.0;
            let sampleFactor = 0;
            let bandIndex = 0;
            let outSampleIndex = 0;
            bandArray.forEach(sample => {
              sampleSum += sample;
              sampleFactor++;
              bandIndex++;

              let sampleTestIndex = Math.floor(bandIndex / sampleCountFactor);

              if (sampleTestIndex > outBand.length) {
                outBand.push(Number((sampleSum / sampleFactor).toFixed(1)));
                sampleSum = 0.0;
                sampleFactor = 0;
              }
            });
            outArray.push(outBand);
          });

          return outArray;
        };
        let fft_song_samples = async (samples_per_rift) => {
          let bufferUsed = 0;
          let song_sample_ctr = 0;
          let song_chunks = [];
          let freq_chunks = [];
          let file_bytes = this.song_samples;

          let smooth_bands = (in_array) => {
            let l = in_array.length;
            let out_array = [];
            this.combined_bands = Number(this.bands_to_combine.value);

            for (let c = 0; c < l; c += this.combined_bands) {
              let sum = 0.0;
              for (let d = 0; d < this.combined_bands; d++) {
                sum += in_array[d + c];
              }

              out_array.push(Math.round(sum / this.combined_bands));
            }

            return out_array;
          };

          while (bufferUsed < (this.song_samples.length - samples_per_rift)) {
            let data_to_process = this.song_samples.slice(bufferUsed, bufferUsed + samples_per_rift);
            bufferUsed += samples_per_rift;
            song_sample_ctr++;

            song_chunks.push(data_to_process);

            let ft = new FFT(samples_per_rift, this.sampleRate);
            ft.forward(data_to_process);
            let fewer_bands = smooth_bands(ft.spectrum);
            freq_chunks.push(fewer_bands);
          }

          return freq_chunks;
        };
        let convert_raw_to_samples = () => {
          let samples = [];
          let ratioToKeep = this.seconds / this.seconds_clip;
          let sampleLimit = this.rawBytes.length / ratioToKeep;

          //convert to 16 bits and clip size
          if (this.bitSize > 8) {
            for (let c = 0, l = this.sampleLimit - 1; c < l; c += 2) {
              samples.push(this.rawBytes[c + 1] * 256 + this.rawBytes[c]);
            }
          } else {
            samples = this.rawBytes;
          }

          return samples;
        };
        let fileBlobToArrayBuffer = (file) => {
          return new Promise((resolve, reject) => {
            let reader = new FileReader();

            reader.onload = () => {
              let array = new Uint8Array(reader.result);
              resolve(array);
            };

            reader.onerror = (err) => {
              console.log('File Reader Error', err);
              reject(err);
            };

            reader.readAsArrayBuffer(file);
          });
        }
        let song_bytes = await fileBlobToArrayBuffer(this.audio_file.files[0]);
        let html_out = '';
        if (song_bytes) {
          let riffTest = new TextDecoder().decode(song_bytes.slice(0, 4));
          if (riffTest !== 'RIFF') {
            alert('must be WAV file');
            return;
          }
          this.totalSize = song_bytes[7] * (256 * 256 * 256) +
            song_bytes[6] * (256 * 256) +
            song_bytes[5] * (256) +
            song_bytes[4];
          html_out += 'total size: ' + this.totalSize + '<br>';
          let wavTEST = new TextDecoder().decode(song_bytes.slice(8, 15));
          if (wavTEST !== 'WAVEfmt') {
            alert('must be WAV file');
            return;
          }
          this.sampleBits = song_bytes[19] * (256 * 256 * 256) +
            song_bytes[18] * (256 * 256) +
            song_bytes[17] * (256) +
            song_bytes[16];
          html_out += 'sample bits:' + this.sampleBits + '<br>';

          let audioFormat = song_bytes[21] * (256) +
            song_bytes[20];

          this.channels = song_bytes[23] * (256) +
            song_bytes[22];
          html_out += 'channels: ' + this.channels + '<br>';

          this.sampleRate = song_bytes[27] * (256 * 256 * 256) +
            song_bytes[26] * (256 * 256) +
            song_bytes[25] * (256) +
            song_bytes[24];
          html_out += 'sample rate:' + this.sampleRate + '<br>';

          this.byteRate = song_bytes[31] * (256 * 256 * 256) +
            song_bytes[30] * (256 * 256) +
            song_bytes[29] * (256) +
            song_bytes[28];
          html_out += 'byteRate: ' + this.byteRate + '<br>';

          let blockAlign = song_bytes[33] * (256) +
            song_bytes[32];
          html_out += 'blockAlign: ' + blockAlign + '<br>';

          this.bitRate = song_bytes[35] * (256) +
            song_bytes[34];
          html_out += 'bitRate: ' + this.bitRate + '<br>';
          let dataTEST = new TextDecoder().decode(song_bytes.slice(36, 40));
          if (dataTEST !== 'data') {
            alert('must be WAV file');
            return;
          }

          this.dataChunkHeader = song_bytes[39] * (256 * 256 * 256) +
            song_bytes[38] * (256 * 256) +
            song_bytes[37] * (256) +
            song_bytes[36];
          html_out += 'dataChunkHeader:' + this.dataChunkHeader + '<br>';

          this.fileDataSize = song_bytes[43] * (256 * 256 * 256) +
            song_bytes[42] * (256 * 256) +
            song_bytes[41] * (256) +
            song_bytes[40];
          html_out += 'fileDataSize:' + this.fileDataSize + '<br>';

          this.seconds = this.fileDataSize / this.byteRate;
          this.seconds_clip = this.seconds;
          if (this.seconds_to_sample.value !== '') {
            this.seconds_clip = Number(this.seconds_to_sample.value);
          }
          html_out += 'length: ' + this.seconds.toFixed(1) + 's<br>';

          let v = this.sampleRate / Number(this.bands_to_combine.value);
          html_out += 'freq per band ' + v + 'hz<br>';

          document.getElementById('song_len_sec').innerHTML = html_out;
        } else {
          //alert('no song');
          return;
        }
        this.audio.src = URL.createObjectURL(this.audio_file.files[0]);

        let audio_loaded = async () => {
          return new Promise((resolve, reject) => {
            this.audio.onloadeddata = () => {
              resolve();
            }
          });
        };
        let swap_indexes_n2 = (in_array) => {
          let out_array = [];
          let outer_bound = in_array[0].length;

          for (let c = 0; c < outer_bound; c++) {
            let new_n2_array = [];
            for (let d = 0, dl = in_array.length; d < dl; d++)
              new_n2_array.push(in_array[d][c]);

            out_array.push(new_n2_array)
          }

          return out_array;
        };

        this.audio.load();


        await audio_loaded();
        this.time_length = this.audio.duration; // in seconds

        this.rawBytes = song_bytes.slice(44);
        this.song_samples = await convert_raw_to_samples(song_bytes);

        let song_chunks = await fft_song_samples(512);
        let song_chunks_flipped_indexes = swap_indexes_n2(song_chunks);
        let freqData = [];
        for (let i = 0; i < song_chunks_flipped_indexes.length; i++)
          freqData.push(song_chunks_flipped_indexes[i]);
        //resample to 10 per second  2584 @ 60s => 600 @ 60s
        let resampledArray = resampleData(freqData, this.seconds_clip, Number(this.freq_samples_to_second.value));

        console.log(resampledArray);
        document.getElementById('raw_data').value = JSON.stringify(resampledArray);
      }

      helpPanelToggle() {
        if (this.helpPanelVisible) {
          this.helpPanelVisible = false;
          this.help_viewer_panel.style.display = 'none';
          this.show_help_panel_btn.style.background = '';
          this.show_help_panel_btn.style.color = '';
        } else {
          this.helpPanelVisible = true;
          this.help_viewer_panel.style.display = '';
          this.show_help_panel_btn.style.background = 'rgb(100,100,100)';
          this.show_help_panel_btn.style.color = 'white';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', e => {
      let publish_web = new PublishWeb();
    });
  </script>

  <style>
    .item_holder {
      position: relative;
    }

    .basic_item {
      border-radius: 50%;
      width: 100px;
      height: 40px;
      position: absolute;
      top: 0;
      left: 0;
      color: white;
      font-weight: bold;
      text-align: center;
    }

    body {
      text-align: center;
    }

    .item_holder {
      position: relative;
    }

    .basic_item {
      border-radius: 50%;
      width: 100px;
      height: 40px;
      position: absolute;
      top: 0;
      left: 0;
      color: white;
      font-weight: bold;
      text-align: center;
    }

    select {
      padding-right: 1em;
    }

    #preview_panel {
      width: 200%;
      height: 200%;
      transform: scale(.5);
      padding: 0;
      margin: 0;
      position: relative;
      top: -50%;
      left: -50%;
    }

    .csv_import_preview {
      display: block;
    }

    .csv_import_preview {
      width: inherit;
      overflow: hidden;
      overflow-x: scroll;
    }

    .add-asset-template-panel input {
      margin: 0;
    }

    select.select_list {
      text-align: left;
      margin: 8px;
      width: calc(100%=16px);
      flex: 1;
      min-height: 3em;
    }

    .select_flex_view {
      flex: 2;
      overflow: hidden;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    select.select_list option {
      padding: 4px;
    }

    .main_div_wrapper {
      display: none;
      flex: 1;
      overflow: hidden;
      overflow-y: auto;
      flex-direction: column;
    }

    .target_header {
      width: 100%;
      padding: 0 8px;
    }

    .target_header span {
      white-space: nowrap;
      font-size: .8em;
      float: right;
      clear: right;
    }

    #selected_target_span {
      float: left;
      text-align: left;
    }

    select {
      font-size: 11px;
      border-radius: 0;
    }

    * {
      font-size: 12px;
    }

    button {
      font-size: 12px;
    }

    .body_flex_wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #addon_display_view_select {
      flex: 1;
      margin-left: 8px;
      font-size: 14px;
    }

    #project_display_view {
      overflow: hidden;
    }

    button i.material-icons {
      font-size: 1.5em;
      top: .25em;
    }

    #help_viewer_panel {
      border: solid 1px silver;
      overflow-y: auto;
      margin: 8px 8px 0 8px;
    }
  </style>

</body>

</html>
