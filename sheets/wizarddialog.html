<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
  <link rel="stylesheet" href="https://handtop.com/global/common.css">
  <link rel="stylesheet" href="https://handtop.com/asset/app.css">
  <script src="https://handtop.com/global/globalutil.js"></script>
  <script src="https://handtop.com/global/ginstancesuper.js"></script>
  <script src="https://handtop.com/controller/cmacro.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.6.0/papaparse.min.js"></script>
  <style>
    .item_holder {
      position: relative;
    }

    .basic_item {
      border-radius: 50%;
      width: 100px;
      height: 40px;
      position: absolute;
      top: 0;
      left: 0;
      color: white;
      font-weight: bold;
      text-align: center;
    }

    body {
      text-align: center;
    }

    .csv_import_preview {
      display: block;
    }

    .csv_import_preview {
      width: inherit;
      overflow: hidden;
      overflow-x: scroll;
    }

    .add-asset-template-panel input {
      margin: 0;
    }
  </style>
</head>

<body>
  <div style="height:inherit;overflow:auto;">
    <select id="wizard_choices">
      <option value="block">Blocks</option>
      <option value="mesh">Meshes</option>
      <option value="material">Materials </option>
    </select>

    <div id="macro_details" class="add-asset-template-panel">
    </div>
    <div id="helpviewer">
    </div>
  </div>

  <script>
    class MacroHelper {
      constructor() {
        this.panel = document.getElementById('macro_details');
        this.wizard_choices = document.getElementById('wizard_choices');
        this.helpviewer = document.getElementById('helpviewer');
        this.wizard_choices.addEventListener('change', e => this.changeTag());

        this.app = new cAppDefaults();
        this.app.jsonLibPrefix = 'https://handtop.com';
        this.app.loadTextures();
        this.app.loadPickerData();
        this.changeTag();
        console.log('app', this.app);
      }
      async changeTag() {
        this.macro = new cMacro(this.panel, this.wizard_choices.value, this.app, true);
        console.log('macro', this.macro);
        this.macro._handleImageTextureUpload = (fileCtl, field) => {
          return this._handleImageTextureUpload(fileCtl, field);
        };

        await this.app.updateHelpView(this.wizard_choices.value, this.helpviewer);

        return null;
      }
      async _handleImageTextureUpload(fileCtl, field) {
        let fileBlob = fileCtl.files[0];

        if (!fileBlob)
          return;
        field.value = 'Uploading...';
        let filename = fileBlob.name;
        let publishConfig = await this.grabSheetCSVJSONData('PublishConfig');

        let target = publishConfig[0].defaulttarget;
        let token = publishConfig[0].defaulttoken;
        let project = publishConfig[0].defaultproject;

        if (!project) {
          alert('No default project pinned');
          return;
        }

        if (!target) {
          alert('No default target pinned');
        }

        let url = 'https://us-central1-' + target + '.cloudfunctions.net/fileupload?name=' + encodeURIComponent(project);
        url += '&token=' + encodeURIComponent(token);
        url += '&filename=' + encodeURIComponent(filename);

        let body = new FormData();
        body.append('file', fileBlob);

        let genResponse = await fetch(url, {
          method: "post",
          body
        });
        let genResults = await genResponse.json();
        if (genResults.success)
          if (genResults.result_msg.success) {
            field.value = genResults.result_msg.signed_url;
            let event = new Event('input', {
              bubbles: true,
              cancelable: true,
            });

            field.dispatchEvent(event);
            return genResults;
          }

        field.value = '';
        alert('upload did not complete');
        return null;
      }
      grabSheetCSVJSONData(sheetName) {
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            console.log('json for sheet', sheetName, result.length);
            resolve(result);
          }).getJSONFromCSVSheet(sheetName);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', e => {
      let publish_web = new MacroHelper();
    });
  </script>
</body>

</html>
