<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
  <style>
    .item_holder {
      position: relative;
    }

    .basic_item {
      border-radius: 50%;
      width: 100px;
      height: 40px;
      position: absolute;
      top: 0;
      left: 0;
      color: white;
      font-weight: bold;
      text-align: center;
    }

    body {
      text-align: center;
    }
  </style>
</head>

<body>
  <br>
  <button id="create_publishconfig" class="blue">Create PublishConfig</button>
  <br><br>
  <button id="create_publishlist" class="blue">Create PublishList</button>
  <br><br>
  <button id="create_assetranges" class="blue">Create Asset Ranges</button>
  <hr>
  <b>Templates</b>
  <br>
  <select id="templateslist" style="width:90%;text-align:left;" size="4">
  </select>
  <br>
  <label>Name <input id="sheetname"></label>
  <br>
  <button id="create_layout_btn" class="green">Create Sheet</button>

  <script>
    class PublishWeb {
      constructor() {
        this.create_publishconfig = document.getElementById('create_publishconfig');
        this.create_publishconfig.addEventListener('click', e => this.createSheet('PublishConfig', 'PublishConfig'));

        this.create_publishlist = document.getElementById('create_publishlist');
        this.create_publishlist.addEventListener('click', e => this.createSheet('PublishList', 'PublishList'));

        this.create_assetranges = document.getElementById('create_assetranges');
        this.create_assetranges.addEventListener('click', e => this.createSheet('AssetRanges', 'Asset Ranges'));

        this.sheetname = document.getElementById('sheetname');

        this.templateslist = document.getElementById('templateslist');
        this.fillTemplateList();

        this.create_layout_btn = document.getElementById('create_layout_btn');
        this.create_layout_btn.addEventListener('click', e => this.processTemplate());
      }
      async fillTemplateList() {
        let genResponse = await fetch('https://www.handtop.com/addontemplates/templatelist.json', {
          method: "get"
        });
        let genResults = await genResponse.json();

        let html = '';
        console.log(genResults);
        let selected = 'selected';
        genResults.forEach(i => {
          html += `<option value="${i.key}" ${selected}>${i.name}</option>`;
          selected = '';
        });
        this.templateslist.innerHTML = html;
      }
      async createSheet(layoutName, sheetName, baseSheetName = '') {
        let sheets = layoutName.split(',');

        this.create_layout_btn.innerHTML = '...';
        let genResponse = await fetch('https://www.handtop.com/addontemplates/template_' + layoutName + '.json', {
          method: "get"
        });
        let genText = await genResponse.text();
        if (baseSheetName)
          genText = genText.split('##sheetname').join(baseSheetName);

        let genResults = JSON.parse(genText);
        return new Promise((resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            this.create_layout_btn.innerHTML = 'Create Sheet';
            if (result !== 'success')
              alert(result);
            resolve(result);
          }).createSheetFromTemplate(sheetName, genResults);
        });
      }
      async processTemplate() {
        let sheetName = this.sheetname.value;
        let templateString = this.templateslist.value;
        let templates = templateString.split(',');

        if (!sheetName) {
          alert('Sheet name required');
          return null;
        }

        let promises = [];
        templates.forEach((item, i) => {
          let parts = item.split(':');
          let suffix = parts[1];
          if (!suffix)
            suffix = '';
          let name = sheetName + suffix;
          promises.push(this.createSheet(parts[0], name, sheetName));
        });

        return Promise.all(promises);
      }
    }

    document.addEventListener('DOMContentLoaded', e => {
      let publish_web = new PublishWeb();
    });
  </script>
</body>

</html>
