<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Operations</title>
</head>

<body>
  <input id="admin_doc_path" type="text" style="width:90%" value="/Breweries/empyrean/beers"><br>
  Token: <input id="admin_token" type="text"><br>
  <br>
  <button id="admin_read_doc">Admin Read Doc</button>
  &nbsp;
  <button id="admin_write_doc">Admin Write Doc</button>
  <hr>
  <button id="admin_read_col">Admin Read Collection</button>
  &nbsp;
  <button id="admin_write_col">Admin Write Collection</button>
  <button id="upload_sheet">Upload Sheet</button>
  <hr>
  <div id="resultarea" style="white-space:pre"></div>
  <button id="format_json">Format JSON</button>
  <div id="acearea" style="width:90%;margin:0;height:25em;position:absolute;"></div>
  <!-- Firebase links -->
  <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-firestore.js"></script>
  <script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
      apiKey: "AIzaSyBtmbjwCIZcMayLbhtDKmQK5zBzKGNNd5c",
      authDomain: "promotion-3abec.firebaseapp.com",
      databaseURL: "https://promotion-3abec.firebaseio.com",
      projectId: "promotion-3abec",
      storageBucket: "promotion-3abec.appspot.com",
      messagingSenderId: "935983699941",
      appId: "1:935983699941:web:1a03ec8b37df60559f810c",
      measurementId: "G-ENR9TZTGGV"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    let basePath = 'http://localhost:5001/promotion-3abec/us-central1/';
    basePath = 'https://us-central1-promotion-3abec.cloudfunctions.net/';
    let resultarea = document.getElementById('resultarea');

    document.getElementById('upload_sheet').addEventListener('click', async e => {
      google.script.run.withSuccessHandler((result) => {
        document.getElementById('admin_doc_path').value = result.path;
        let json = JSON.parse(result.data);
        window.editor.setValue(JSON.stringify(json, null, '  '));
        // console.log(result);
        // window.editor.setValue(result.data);
      }).getUploadData();
    })



    document.getElementById('format_json').addEventListener('click', async e => {

      let jsontext = window.editor.getValue();
      let json = JSON.parse(jsontext);
      window.editor.setValue(JSON.stringify(json, null, '\t'));
      //document.getElementById('admin_write_col').click();
    })

    document.getElementById('admin_write_doc').addEventListener('click', async e => {

      resultarea.innerHTML = 'pending';


      let path = document.getElementById('admin_doc_path').value;
      let jsontext = window.editor.getValue();
      let admin_token = document.getElementById('admin_token').value;
      let details = {
        jsontext,
        path
      };
      let formBody = [];
      for (let property in details) {
        let encodedKey = encodeURIComponent(property);
        let encodedValue = encodeURIComponent(details[property]);
        formBody.push(encodedKey + "=" + encodedValue);
      }
      let body = formBody.join("&");

      let f_result = await fetch(basePath + 'webPage/adminwrite', {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'token': admin_token
        },
        body
      });
      let json = await f_result.json();

      if (json.success)
        resultarea.innerHTML = JSON.stringify(json, null, '\t');
      else
        resultarea.innerHTML = JSON.stringify(json, null, '\t');
    });

    document.getElementById('admin_write_col').addEventListener('click', async e => {

      resultarea.innerHTML = 'pending';

      let admin_token = document.getElementById('admin_token').value;

      let path = document.getElementById('admin_doc_path').value;
      let jsontext = window.editor.getValue();
      let token = 'SpecialToken';
      let details = {
        jsontext,
        path
      };
      let formBody = [];
      for (let property in details) {
        let encodedKey = encodeURIComponent(property);
        let encodedValue = encodeURIComponent(details[property]);
        formBody.push(encodedKey + "=" + encodedValue);
      }
      let body = formBody.join("&");

      let f_result = await fetch(basePath + 'webPage/adminwritecol', {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'token': admin_token
        },
        body
      });
      let json = await f_result.json();

      if (json.success)
        resultarea.innerHTML = JSON.stringify(json, null, '\t');
      else
        resultarea.innerHTML = JSON.stringify(json, null, '\t');
    });

    document.getElementById('admin_read_doc').addEventListener('click', async e => {

      resultarea.innerHTML = 'pending';
      let admin_token = document.getElementById('admin_token').value;



      let path = document.getElementById('admin_doc_path').value;
      let token = 'SpecialToken';
      let details = {
        path
      };
      let formBody = [];
      for (let property in details) {
        let encodedKey = encodeURIComponent(property);
        let encodedValue = encodeURIComponent(details[property]);
        formBody.push(encodedKey + "=" + encodedValue);
      }
      let body = formBody.join("&");

      let f_result = await fetch(basePath + 'webPage/adminread', {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'token': admin_token
        },
        body
      });
      let json = await f_result.json();

      if (json.success) {
        resultarea.innerHTML = '';
        window.editor.setValue(JSON.stringify(json.data, null, '\t'));
      } else
        resultarea.innerHTML = JSON.stringify(json, null, '\t');
    });

    document.getElementById('admin_read_col').addEventListener('click', async e => {

      resultarea.innerHTML = 'pending';


      let path = document.getElementById('admin_doc_path').value;
      let admin_token = document.getElementById('admin_token').value;
      let details = {
        path
      };
      let formBody = [];
      for (let property in details) {
        let encodedKey = encodeURIComponent(property);
        let encodedValue = encodeURIComponent(details[property]);
        formBody.push(encodedKey + "=" + encodedValue);
      }
      let body = formBody.join("&");
      console.log(body);
      let f_result = await fetch(basePath + 'webPage/adminreadcol', {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'token': admin_token
        },
        body
      });
      let json = await f_result.json();

      if (json.success) {
        resultarea.innerHTML = '';
        window.editor.setValue(JSON.stringify(json.data, null, '\t'));
      } else
        resultarea.innerHTML = JSON.stringify(json, null, '\t');
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js" type="text/javascript" charset="utf-8"></script>
  <script>
    window.editor = ace.edit("acearea");
    //  window.editor.setTheme("ace/theme/monokai");
    window.editor.getSession().setMode("ace/mode/json");
  </script>
</body>

</html>
