<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
</head>

<body>
  <style>
    body {
      text-align: center;
    }
  </style>
  <br>
  <button id="display_publish_list">Publish List</button>

  <script>
    class PublishWeb {
      constructor() {
        this.display_publish_list = document.getElementById('display_publish_list');
        this.display_publish_list.addEventListener('click', e => this.publishList());
      }
      async publishList() {
        if (this.busy)
          return;
        this.display_publish_list.innerHTML = 'Working...';

        this.busy = true;
        let publishConfig = await this.grabSheetCSVJSONData('PublishConfig');
        let publishListSheet = publishConfig[0].displaylist;
        window.apiToken = publishConfig[0].token;
        window.fbProj = publishConfig[0].firebaseproject;
        let publishList = await this.grabSheetCSVJSONData(publishListSheet);

        let promises = [];
        let start = 0;
        let end = publishList.length - 1;
        if (publishConfig[0].startat)
          start = Number(publishConfig[0].startat);
        if (publishConfig[0].endat)
          end = Number(publishConfig[0].endat);

        for (let c = start; c <= end; c++) {
          let row = publishList[c];
          console.log(row);
          promises.push(this.publishSingle(row.name, row.assetranges, row.circuitranges, row.catalogsheet));

          if (promises.length > 9) {
            let results = await Promise.all(promises);
            console.log(c, results);
            promises = [];
          }
        }

        let results = await Promise.all(promises);
        console.log('last', results);
        this.busy = false;
        this.display_publish_list.innerHTML = 'Publish Web Again';

        return results;
      }
      async publishSingle(name, assetRanges, circuitRanges, catalogSheet) {
        console.log(name, assetRanges, circuitRanges, catalogSheet);
        try {
          let assetResults = {};
          if (assetRanges) {
            let ranges = assetRanges.split(',');
            let assets = await this.grabCSVForRangeStrings(ranges);
            console.log('assets', assets);
            let url = 'https://us-central1-' + window.fbProj + '.cloudfunctions.net/upload?name=';
            url += encodeURIComponent(name) + '&type=asset';
            url += '&token=' + encodeURIComponent(window.apiToken);
            let json = JSON.stringify(assets);

            let response = await fetch(url, {
              method: "post",
              body: json
            });
            assetResults = await response.text();
          }

          let sceneResults = {};
          if (circuitRanges) {
            let ranges = circuitRanges.split(',');
            let scene = await this.grabCSVForRangeStrings(ranges);
            console.log('circuitRanges', scene);
            let url = 'https://us-central1-' + window.fbProj + '.cloudfunctions.net/upload?name=';
            url += encodeURIComponent(name) + '&type=scene';
            url += '&token=' + encodeURIComponent(window.apiToken);
            let json = JSON.stringify(scene);
            let response = await fetch(url, {
              method: "post",
              body: json
            });
            sceneResults = await response.text();
          }

          let productResults = {};
          if (catalogSheet) {
            let products = await this.grabSheetCSVJSONData(catalogSheet);
            console.log('products', products);
            let url = 'https://us-central1-' + window.fbProj + '.cloudfunctions.net/upload?name=';
            url += encodeURIComponent(name) + '&type=product';
            url += '&token=' + encodeURIComponent(window.apiToken);
            let json = JSON.stringify(products);
            let response = await fetch(url, {
              method: "post",
              body: json
            });
            productResults = await response.text();
          }

          let url = 'https://us-central1-' + window.fbProj + '.cloudfunctions.net/generate/?name=' + encodeURIComponent(name);
          url += '&token=' + encodeURIComponent(window.apiToken);
          let genResponse = await fetch(url, {
            method: "post"
          });
          let genResults = await genResponse.text();

          return {
            genResults,
            productResults,
            assetResults,
            sceneResults
          };
        } catch (error) {
          console.log('e', error);
          return {
            error: error
          };
        }
      }
      grabSheetCSVJSONData(sheetName) {
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            console.log(sheetName, result.length);
            resolve(result);
          }).getJSONFromCSVSheet(sheetName);
        });
      }
      grabCSVForRangeStrings(rangeStrings) {
        return new Promise(async (resolve, reject) => {
          google.script.run.withSuccessHandler((result) => {
            console.log(rangeStrings, result.length);
            resolve(result);
          }).mergeCSVRangeStrings(rangeStrings);
        });
      }
    }


    document.addEventListener('DOMContentLoaded', e => {
      let FFT_file = new PublishWeb();
    });
  </script>
</body>

</html>
