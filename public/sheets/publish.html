<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
  <style>
    body {
    text-align: center;
    }
   </style>
  <br>
     <button id="display_publish_list">Publish List</button>
 <br>
 <br>
    <hr>
    <button id="display_publish">Publish Single</button>
    <br>
    <br>
    wid <input id="workspace_id" value="-M3o9lFX579wmY4LiKC-" />
    <br>
    <br>
    assets sheet <input id="assets_sheet" value="bottleassets" />
    <br>
    <br>
    scene sheet <input id="scene_sheet" value="starwarscarousel" />
     <br>
    <br>
    products sheet <input id="products_sheet" value="" />
    <br>

    <br>
    <script>
      class PublishWeb {
        constructor() {
          this.display_publish = document.getElementById('display_publish');
          this.workspace_id = document.getElementById('workspace_id');
          this.assets_sheet = document.getElementById('assets_sheet');
          this.scene_sheet = document.getElementById('scene_sheet');
          this.products_sheet = document.getElementById('products_sheet');
          this.display_publish_list = document.getElementById('display_publish_list');

          this.display_publish.addEventListener('click',(e) => this.publish());
          this.display_publish_list.addEventListener('click', e => this.publishList());
        }
        async publishList() {
          let publishList = await this.grabSheetCSVJSONData('PublishList');

          let promises = [];

          publishList.forEach(row => {
            console.log(row);
            promises.push(this.publishSingle(row.wid, row.assetssheet, row.scenesheet, row.productssheet));
          });

          let results = await Promise.all(promises);
          console.log(results);
          return results;
        }
        async publishSingle(id, assetSheet, sceneSheet, productSheet) {
        console.log(id, assetSheet, sceneSheet, productSheet);
          let assetResults = {};
          if (assetSheet) {
            let assets = await this.grabSheetCSVJSONData(assetSheet);
            let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/upload?id=';
            url += encodeURIComponent(id) + '&type=asset';
            let json = JSON.stringify(assets);

            let response = await fetch(url, {
              method: "post",
              body: json
            });
            assetResults = await response.text();
          }

          let sceneResults = {};
          if (sceneSheet) {
            let scene = await this.grabSheetCSVJSONData(sceneSheet);
            let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/upload?id=';
            url += encodeURIComponent(id) + '&type=scene';
            let json = JSON.stringify(scene);
            let response = await fetch(url, {
              method: "post",
              body: json
            });
            sceneResults = await response.text();
          }

          let productResults = {};
          if (productSheet) {
            let products = await this.grabSheetCSVJSONData(productSheet);
            let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/upload?id=';
            url += encodeURIComponent(id) + '&type=product';
            let json = JSON.stringify(products);
            let response = await fetch(url, {
              method: "post",
              body: json
            });
            productResults = await response.text();
          }

          let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/generate/?id=' + encodeURIComponent(id);
          let genResponse = await fetch(url, {
            method: "post"
          });
          let genResults = await genResponse.text();

          return {
            genResults,
            productResults,
            assetResults,
            sceneResults
          };
        }
        async publish() {
          let results = await this.publishSingle(this.workspace_id.value, this.assets_sheet.value,
                    this.scene_sheet.value, this.products_sheet.value);
          console.log('single', results);
          return results;
        }

        grabSheetCSVJSONData(sheetName) {
          return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler((result) => {
              resolve(result)
            }).getJSONFromCSVSheet(sheetName);
          });
        }
      }


      document.addEventListener('DOMContentLoaded', e => {
        let FFT_file = new PublishWeb();
      });
    </script>
  </body>
</html>
