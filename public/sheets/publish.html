<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
  <style>
    body {
    text-align: center;
    }
   </style>
  <br>
     <button id="display_publish_list">Publish List</button>
 <hr>
     <button id="refresh_oauth_btn">Refresh OAuth</button>
 <hr>
 <br>
   <button id="publish_data">Log JSON List to console</button>
 <br>
    <hr>
    <button id="display_publish">Publish Single</button>
    <br>
    <br>
    wid <input id="workspace_id" value="-M3o9lFX579wmY4LiKC-" />
    <br>
    <br>
    assets sheet <input id="assets_sheet" value="bottleassets" />
    <br>
    <br>
    circuit sheet <input id="scene_sheet" value="starwarscarousel" />
     <br>
    <br>
    catalog sheet <input id="products_sheet" value="carouselcatalogflat" />
    <br>

    <br>
    <script>
      class PublishWeb {
        constructor() {
          this.display_publish = document.getElementById('display_publish');
          this.workspace_id = document.getElementById('workspace_id');
          this.assets_sheet = document.getElementById('assets_sheet');
          this.scene_sheet = document.getElementById('scene_sheet');
          this.products_sheet = document.getElementById('products_sheet');
          this.display_publish_list = document.getElementById('display_publish_list');
          this.refresh_oauth_btn = document.getElementById('refresh_oauth_btn');
          this.refresh_oauth_btn.addEventListener('click', e => {
            google.script.run.withSuccessHandler((result) => {
              alert('done - please refresh assets tab', 'oauth refresh');
            }).refreshOAuth();
          });

          this.display_publish.addEventListener('click',(e) => this.publish());
          this.display_publish_list.addEventListener('click', e => this.publishList());

          this.publish_data = document.getElementById('publish_data');
          this.publish_data.addEventListener('click', async e => {
             let publishConfig = await this.grabSheetCSVJSONData('PublishConfig');
      console.log(publishConfig);
             let publishListSheet = publishConfig[0].displaylist;
             let publishList = await this.grabSheetCSVJSONData(publishListSheet);
            console.log('list', JSON.stringify(publishList));
          });
        }
        async publishList() {
          let publishConfig = await this.grabSheetCSVJSONData('PublishConfig');
          let publishListSheet = publishConfig[0].displaylist;
          let publishList = await this.grabSheetCSVJSONData(publishListSheet);

          this.display_publish_list.innerHTML = 'Working...';
          let promises = [];
          let start = 0;
          let end = publishList.length - 1;
          if (publishConfig[0].startat)
            start = Number(publishConfig[0].startat);
           if (publishConfig[0].endat)
             end = Number(publishConfig[0].endat);

          for (let c = start; c <= end; c++) {
            let row = publishList[c];
            console.log(row);
            promises.push(this.publishSingle(row.wid, row.assetssheet, row.circuitsheet, row.catalogsheet));

            if (promises.length > 9) {
              let results = await Promise.all(promises);
              console.log(c, results);
              promises = [];
            }
          }

          let results = await Promise.all(promises);
          console.log('last', results);
          this.display_publish_list.innerHTML = 'Publish Web Again';

          return results;
        }
        async publishSingle(id, assetSheet, sceneSheet, productSheet) {
          console.log(id, assetSheet, sceneSheet, productSheet);
          try {
            let assetResults = {};
            if (assetSheet) {
              let assets = await this.grabSheetCSVJSONData(assetSheet);
              let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/upload?id=';
              url += encodeURIComponent(id) + '&type=asset';
              let json = JSON.stringify(assets);

              let response = await fetch(url, {
                method: "post",
                body: json
              });
              assetResults = await response.text();
            }

            let sceneResults = {};
            if (sceneSheet) {
              let scene = await this.grabSheetCSVJSONData(sceneSheet);
              let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/upload?id=';
              url += encodeURIComponent(id) + '&type=scene';
              let json = JSON.stringify(scene);
              let response = await fetch(url, {
                method: "post",
                body: json
              });
              sceneResults = await response.text();
            }

            let productResults = {};
            if (productSheet) {
              let products = await this.grabSheetCSVJSONData(productSheet);
              let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/upload?id=';
              url += encodeURIComponent(id) + '&type=product';
              let json = JSON.stringify(products);
              let response = await fetch(url, {
                method: "post",
                body: json
              });
              productResults = await response.text();
            }

            let url = 'https://us-central1-groceryblocks2.cloudfunctions.net/generate/?id=' + encodeURIComponent(id);
            let genResponse = await fetch(url, {
              method: "post"
            });
            let genResults = await genResponse.text();

            return {
              genResults,
              productResults,
              assetResults,
              sceneResults
            };
           } catch (error) {
             console.log('e', error);
             return {
              error: error
             };
            }
        }
        async publish() {
          let results = await this.publishSingle(this.workspace_id.value, this.assets_sheet.value,
                    this.scene_sheet.value, this.products_sheet.value);
          console.log('single', results);
          return results;
        }

        grabSheetCSVJSONData(sheetName) {
          return new Promise(async (resolve, reject) => {
            google.script.run.withSuccessHandler((result) => {
              console.log(sheetName, result.length);
              resolve(result);
            }).getJSONFromCSVSheet(sheetName);
          });
        }
      }


      document.addEventListener('DOMContentLoaded', e => {
        let FFT_file = new PublishWeb();
      });
    </script>
  </body>
</html>
