<!DOCTYPE html>
<html>

<head>
  <title>Chained To Await</title>
</head>

<body>
  <div>
    <div>
      Forward<br>
      This example demonstrates converting promises chained in the previous step to await based execution.<br>
    </div>
    Audio File: <input type="file" class="audio_file" />
    <br>
    <br>
    <audio id="audio" controls></audio>
    <br>
    <br>
    <button id="next_step">Next Step</button>
    <br>
    <br>
    <textarea id="output_area" style="width:600px;height:400px;"></textarea>
  </div>
  <script>
    let audio_file = document.querySelector('.audio_file');

    function file_to_array(file) {
      return new Promise((resolve, reject) => {
        let reader = new FileReader();

        reader.onload = () => {
          let array = new Uint8Array(reader.result);
          //console.log('File Buffer Loaded.  Size: ', array.length);
          resolve(array);
        };

        reader.onerror = (err) => {
          console.log('File Reader Error', err);
          reject(err);
        };

        reader.readAsArrayBuffer(file);
      });
    }

    function block_until_next_click(in_result) {
      return new Promise(resolve => {
        let next_step = document.getElementById('next_step');
        let listener = next_step.addEventListener('click', e => {
          next_step.removeEventListener('click', listener);
          resolve(in_result);
        });
      });
    }

    function audio_loaded() {
      return new Promise((resolve, reject) => {
        audio.onloadeddata = () => {
          resolve();
        }
      });
    }

    audio_file.onchange = async () => {
      document.getElementById('output_area').value = 'File Selected - click [Next Step] to continue';

      try {
        let buffer = await file_to_array(audio_file.files[0]);
        //console.log('Raw File Buffer', buffer);
        await block_until_next_click();

        document.getElementById('output_area').value = 'File Buffering - click [Next Step] to continue';
        audio.src = URL.createObjectURL(audio_file.files[0]);

        await block_until_next_click();

        audio.load();

        await audio_loaded();

        document.getElementById('output_area').value = 'File Loading - click [Next Step] to continue';

        await block_until_next_click();

        audio.play();
        document.getElementById('output_area').value = 'File Playing - click [Next Step] to stop audio';

        await block_until_next_click();

        audio.pause();

        let msg = 'File Paused - click [Next Step] to throw error';
        document.getElementById('output_area').value = msg;

        await block_until_next_click();

        throw 'generated error';

        let notreached =  'not reachable step due to previous error';
        console.log(notreached, 'so it is used');
      } catch (err) {
        document.getElementById('output_area').value = err;
      }
    };
  </script>
</body>

</html>
